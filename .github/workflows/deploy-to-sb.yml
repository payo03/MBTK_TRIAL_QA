name: Deploy IC2 Metadata to MTBK_SB

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: npm install -g sfdx-cli

      - name: Authenticate to MTBK_SB
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > sfdx_auth.txt
          sfdx force:auth:sfdxurl:store -f sfdx_auth.txt -a MTBK_SB

      - name: Convert Metadata (IC2 src â†’ SFDX format)
        run: |
          sfdx force:mdapi:convert -r src -d converted

      - name: Deploy to MTBK_SB (Smart Test Matching)
        run: |
          echo "ğŸ“¦ Git fetch ì¤‘..."
          git fetch origin master:refs/remotes/origin/master

          echo "ğŸ” origin/master ì™€ HEAD ê°„ì˜ diff í™•ì¸"
          CHANGED_CLASSES=$(git log -1 --name-only | grep '\.cls$' | grep -v '_test.cls' || true)
          echo "ğŸ” ìµœê·¼ ì»¤ë°‹ì—ì„œ ë³€ê²½ëœ Apex í´ë˜ìŠ¤ ì¶”ì¶œ"
  
  
          echo "ğŸ¯ Pushëœ Apex í´ë˜ìŠ¤ ëª©ë¡:"
          echo "$CHANGED_CLASSES"

          TEST_CLASSES=""
          for class_file in $CHANGED_CLASSES; do
            base=$(basename "$class_file" .cls)
            test_file="converted/classes/${base}_test.cls"

            if [ -f "$test_file" ]; then
              TEST_CLASSES+="${base}_test,"
            else
              # ì–´ë…¸í…Œì´ì…˜ ê¸°ë°˜ í…ŒìŠ¤íŠ¸ ì¶”ì 
              target=$(grep "@Target" "$class_file" | sed -E 's/.*@Target[[:space:]]*:[[:space:]]*//;s/\\.cls[[:space:]]*$//' | xargs)
              target_file="converted/classes/${target}.cls"
              if [ -f "$target_file" ]; then
                echo "ğŸ’¡ ì–´ë…¸í…Œì´ì…˜ ê¸°ë°˜ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ë°œê²¬: ${target}"
                TEST_CLASSES+="${target},"
              fi
            fi
          done

          TEST_CLASSES=$(echo "$TEST_CLASSES" | sed 's/,$//')

          if [ -n "$TEST_CLASSES" ]; then
            echo "âœ… ì‹¤í–‰í•  í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤: $TEST_CLASSES"
            sfdx force:source:deploy \
              -p converted \
              -u MTBK_SB \
              --testlevel RunSpecifiedTests \
              --runtests "$TEST_CLASSES"
          else
            echo "â„¹ï¸ Pushëœ Apex í´ë˜ìŠ¤ëŠ” ì—†ê±°ë‚˜ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ì—†ìŒ â†’ í…ŒìŠ¤íŠ¸ ìƒëµ"
            sfdx force:source:deploy \
              -p converted \
              -u MTBK_SB \
              --testlevel NoTestRun
          fi
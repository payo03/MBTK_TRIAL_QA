name: Deploy IC2 Metadata to MTBK_SB

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Salesforce CLI
        run: npm install -g sfdx-cli

      - name: Authenticate to MTBK_SB
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > sfdx_auth.txt
          sfdx force:auth:sfdxurl:store -f sfdx_auth.txt -a MTBK_SB

      - name: Convert Metadata (IC2 src → SFDX format)
        run: |
          sfdx force:mdapi:convert -r src -d converted

      - name: Deploy to MTBK_SB (Test only for pushed Apex classes)
        run: |
          echo "📦 Git fetch 중..."
          git fetch origin master:refs/remotes/origin/master

          echo "🔍 origin/master 와 HEAD 간의 diff 확인"
          CHANGED_CLASSES=$(git diff --name-only origin/master...HEAD 2>/dev/null | grep '\.cls$' | grep -v '_test.cls' || true)

          echo "🎯 Push된 Apex 클래스 목록:"
          echo "$CHANGED_CLASSES"

          TEST_CLASSES=""
          for class_file in $CHANGED_CLASSES; do
            base=$(basename "$class_file" .cls)
            test_file="converted/classes/${base}_test.cls"
            if [ -f "$test_file" ]; then
              TEST_CLASSES+="${base}_test,"
            fi
          done

          TEST_CLASSES=$(echo "$TEST_CLASSES" | sed 's/,$//')

          if [ -n "$TEST_CLASSES" ]; then
            echo "✅ 실행할 테스트 클래스: $TEST_CLASSES"
            sfdx force:source:deploy               -p converted               -u MTBK_SB               --testlevel RunSpecifiedTests               --runtests "$TEST_CLASSES"
          else
            echo "ℹ️ Push된 Apex 클래스는 없거나 테스트 클래스 없음 → 테스트 생략"
            sfdx force:source:deploy               -p converted               -u MTBK_SB               --testlevel NoTestRun
          fi